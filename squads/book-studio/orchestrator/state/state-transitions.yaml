# State Transitions — Pipeline State Machine
version: "1.0.0"
description: "Transicoes validas entre estados do pipeline"

states:
  - id: not_started
    label: "Nao iniciado"

  - id: extract_in_progress
    label: "Extract em andamento"

  - id: extract_gate_pending
    label: "Gate Extract→Transform pendente"

  - id: extract_gate_blocked
    label: "Gate Extract→Transform bloqueado"

  - id: transform_in_progress
    label: "Transform em andamento"

  - id: revision_loop
    label: "Loop de revisao (Editor ↔ Critic)"

  - id: transform_gate_pending
    label: "Gate Transform→Load pendente"

  - id: transform_gate_blocked
    label: "Gate Transform→Load bloqueado"

  - id: load_in_progress
    label: "Load em andamento"

  - id: completed
    label: "Pipeline completo"

  - id: paused
    label: "Pipeline pausado"

  - id: error
    label: "Erro no pipeline"

transitions:
  - from: not_started
    to: extract_in_progress
    trigger: "*run-pipeline"

  - from: extract_in_progress
    to: extract_gate_pending
    trigger: "Extract stage complete"

  - from: extract_gate_pending
    to: transform_in_progress
    trigger: "Gate passed (auto_pass or review approved)"

  - from: extract_gate_pending
    to: extract_gate_blocked
    trigger: "Gate blocked"

  - from: extract_gate_blocked
    to: extract_in_progress
    trigger: "Issues resolved, retry"

  - from: transform_in_progress
    to: revision_loop
    trigger: "Chapter ready for review"

  - from: revision_loop
    to: transform_in_progress
    trigger: "Critic score >= 7 or force exit"

  - from: transform_in_progress
    to: transform_gate_pending
    trigger: "All chapters reviewed"

  - from: transform_gate_pending
    to: load_in_progress
    trigger: "Gate passed"

  - from: transform_gate_pending
    to: transform_gate_blocked
    trigger: "Gate blocked"

  - from: transform_gate_blocked
    to: transform_in_progress
    trigger: "Issues resolved, retry"

  - from: load_in_progress
    to: completed
    trigger: "All Load tasks complete"

  # Pause/Resume
  - from: "*"  # any state except completed/error
    to: paused
    trigger: "*pause or user interrupt"

  - from: paused
    to: "{previous_state}"
    trigger: "*resume"

  # Error recovery
  - from: "*"
    to: error
    trigger: "Unrecoverable error"

  - from: error
    to: "{last_known_good_state}"
    trigger: "Manual recovery"

scenarios:
  extract_gate_blocked:
    description: "Gate Extract→Transform bloqueou porque criterios required falharam"
    example: "Premissa vaga ('escrever algo sobre tempo'), genre_defined: false"
    recovery: "Retornar ao Muse para refinar premissa. Quando resolvido, retry gate."
    test_trigger: "Submeter pipeline com premissa < 10 caracteres"

  transform_gate_blocked:
    description: "Gate Transform→Load bloqueou porque manuscrito nao aprovado"
    example: "Critic score 5.0 apos 3 iteracoes (force_exit), critical issues pendentes"
    recovery: "Retornar ao Editor/Scribe para resolver. Pode exigir rewrite de capitulos."
    test_trigger: "Simular Critic dando score < 7 em todas 3 iteracoes + critical issue"

  paused:
    description: "Pipeline pausado por intervencao manual do autor"
    example: "Autor quer revisar outline antes de Scribe comecar a escrever"
    recovery: "Comando *resume retorna ao estado anterior. Book-state preservado."
    test_trigger: "Comando *pause durante transform_in_progress"
    preserves: ["book-state", "pipeline-state", "handoffs", "checkpoints"]

  error:
    description: "Erro irrecuperavel no pipeline"
    example: "Agente indisponivel, schema corrompido, book-state inconsistente"
    recovery: "Diagnosticar erro, corrigir causa, comando *resume para last_known_good_state"
    test_trigger: "Simular falha de schema validation em handoff"
    preserves: ["book-state (ultimo checkpoint)", "pipeline-state", "log de execucao"]
